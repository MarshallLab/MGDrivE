<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MGDrivE2: Simulation of Time-inhomogeneous Stochastic Processes (Seasonality) • MGDrivE2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="MGDrivE2: Simulation of Time-inhomogeneous Stochastic Processes (Seasonality)">
<meta property="og:description" content="MGDrivE2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">MGDrivE2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/advanced_topics.html">MGDrivE2: Advanced Topics</a>
    </li>
    <li>
      <a href="../articles/epi-SEIR.html">MGDrivE2: SEIR Epidemiological Dynamics</a>
    </li>
    <li>
      <a href="../articles/epi-network.html">MGDrivE2: Metapopulation Network Epidemiological Dynamics</a>
    </li>
    <li>
      <a href="../articles/epi-node.html">MGDrivE2: One Node Epidemiological Dynamics</a>
    </li>
    <li>
      <a href="../articles/inhomogeneous.html">MGDrivE2: Simulation of Time-inhomogeneous Stochastic Processes (Seasonality)</a>
    </li>
    <li>
      <a href="../articles/lifecycle-network.html">MGDrivE2: Metapopulation Network Lifecycle Dynamics</a>
    </li>
    <li>
      <a href="../articles/lifecycle-node.html">MGDrivE2: One Node Lifecycle Dynamics</a>
    </li>
    <li>
      <a href="../articles/output-storage.html">MGDrivE2: Data Storage and Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/MarshallLab/MGDrivE/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="inhomogeneous_files/header-attrs-2.5/header-attrs.js"></script><link href="inhomogeneous_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="inhomogeneous_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>MGDrivE2: Simulation of Time-inhomogeneous Stochastic Processes (Seasonality)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/MarshallLab/MGDrivE/blob/master/vignettes/inhomogeneous.Rmd"><code>vignettes/inhomogeneous.Rmd</code></a></small>
      <div class="hidden name"><code>inhomogeneous.Rmd</code></div>

    </div>

    
    
<div id="table-of-contents" class="section level2">
<h2 class="hasAnchor">
<a href="#table-of-contents" class="anchor"></a>Table of Contents</h2>
<ol style="list-style-type: decimal">
<li><a href="#inhom_adult_mort">Time-Inhomogeneous Adult Mortality</a></li>
<li>
<a href="#inhom_rate_fns">Time-Dependent Rate Functions</a>
<ol style="list-style-type: decimal">
<li><a href="#math_consider">Mathematical Considerations</a></li>
<li><a href="#programming">Programming Time-Dependent Rates in MGDrivE2</a></li>
</ol>
</li>
<li>
<a href="#make_spn">Petri Net Setup</a>
<ol style="list-style-type: decimal">
<li><a href="#pars">Parameterization</a></li>
<li><a href="#init_pn">Initialization of the Petri Net</a></li>
<li><a href="#equilibria_haz">Equilibrium Conditions and Hazard Functions</a></li>
</ol>
</li>
<li>
<a href="#sim">Simulation of Fully Specified SPN Model</a>
<ol style="list-style-type: decimal">
<li><a href="#sim_ode">Simulation: ODE Models</a></li>
<li><a href="#sim_ctmc">Simulation: CTMC Models</a></li>
</ol>
</li>
<li><a href="#plots">Results</a></li>
<li><a href="#ref">References</a></li>
</ol>
<div id="preface" class="section level3">
<h3 class="hasAnchor">
<a href="#preface" class="anchor"></a>Preface</h3>
<p>The Stochastic Petri net (SPN) framework used in <strong>MGDrivE2</strong> allows for different functional forms of the hazard functions (or rates, if the model is being interpreted as a set of ordinary differential equations, ODEs. We use the terms hazard/rate function interchangeably). This means that time-dependent/inhomogeneous rates are relatively simple to incorporate into the model, without even changing the underlying Petri Net. We remark here that <em>exact</em> simulation of time-inhomogeneous stochastic processes is difficult, and the sampling algorithms to support such simulation have not yet been incorporated into <strong>MGDrivE2</strong> (ODE simulation will, of course, be “exact”). However, the Poisson time-step sampler provided with <strong>MGDrivE2</strong> will be correct as the stochastic time-step approaches zero, and we recommend its use for simulating inhomogeneous, continuous-time Markov chain models. Exact algorithms for simulating time-inhomogeneous processes can be found in the works of <a href="https://aip.scitation.org/doi/full/10.1063/1.2799998">Anderson</a> and <a href="https://aip.scitation.org/doi/abs/10.1063/1.4927916">Thanh</a>. Future development efforts will concentrate on better exact and approximate sampling algorithms.</p>
<p>We start by loading the <strong>MGDrivE2</strong> package, as well as the <strong>MGDrivE</strong> package for access to inheritance cubes, <strong>ggplot2</strong> for graphical analysis, and <strong>parallel</strong> for running stochastic repetitions in parallel.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># simulation functions</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marshalllab.github.io/MGDrivE/">MGDrivE2</a></span><span class="op">)</span>
<span class="co">#&gt; Loading MGDrivE2: Mosquito Gene Drive Explorer Version 2</span>
<span class="co"># inheritance patterns</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marshalllab.github.io/MGDrivE/">MGDrivE</a></span><span class="op">)</span>
<span class="co">#&gt; Loading MGDrivE: Mosquito Gene Drive Explorer</span>
<span class="co"># plotting</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="co"># parallel sims</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="inhom_adult_mort" class="section level1">
<h1 class="hasAnchor">
<a href="#inhom_adult_mort" class="anchor"></a>Time-Inhomogeneous Adult Mortality</h1>
<p>Let us consider the case where we want to simulate a model in which the transitions made by functions <code>make_transition_male_mort()</code> and <code>make_transition_female_mort()</code>, that is, the adult male and female mosquito mortality, fire at a rate which depends on time. This time-dependence can in general be arbitrarily complex, as long as the rate function returns a non-negative number at any positive time <span class="math inline">\(t&gt;0\)</span> when it is queried. Therefore various time-inhomogeneous effects can be taken into account in <strong>MGDrivE2</strong>, from long-term climactic and seasonal changes, to rapidly oscillating changes from diurnal cycles.</p>
<p>Sample data included in <strong>MGDrivE2</strong> (<code>mu_ts</code>) provides estimated time-dependent adult mortality rates from the Comoros Islands, between Mozambique and Madagascar. These are hourly death rates over the course of an entire year, for Grande Comore, Moheli, and Anjouan.</p>
<p>First, we load the <code>mu_ts</code> object, which is a matrix of hourly death rates. Now we want to interpolate the death rates into a function that can return a death rate at any time in the interval <span class="math inline">\(0&lt;t&lt;365\)</span>. We could do this with a variety of methods, including splines and other smoothing algorithms, but for now we will use a simple step function with steps every hour, created with the function <code><a href="https://rdrr.io/r/stats/stepfun.html">stepfun()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load mortality data</span>
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">mu_ts</span><span class="op">)</span>

<span class="co"># vector of hourly timesteps</span>
<span class="co">#  unit is in days, so 24 steps per day, 365 days</span>
<span class="va">tt_ts</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">mu_ts</span><span class="op">)</span><span class="op">/</span><span class="fl">24</span>

<span class="co"># exaggerated amplitude of Grande Comore mortality rate, for visual effect</span>
<span class="va">mu_ts_par</span> <span class="op">&lt;-</span> <span class="va">mu_ts</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="op">(</span> <span class="op">(</span><span class="va">mu_ts</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mu_ts</span><span class="op">[</span> ,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">)</span> <span class="op">*</span> <span class="fl">50</span><span class="op">)</span>

<span class="co"># approximating step function</span>
<span class="va">step_approx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/stepfun.html">stepfun</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">tt_ts</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">mu_ts_par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">mu_ts_par</span><span class="op">)</span>,
                       f <span class="op">=</span> <span class="fl">0</span>, right <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>For clarity, we plot the approximating function evaluated at each hour over the year:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># long-form for ggplot2</span>
<span class="va">df_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">"time"</span> <span class="op">=</span> <span class="va">tt_ts</span>, <span class="st">"mu"</span> <span class="op">=</span> <span class="fu">step_approx</span><span class="op">(</span>v <span class="op">=</span> <span class="va">tt_ts</span><span class="op">)</span><span class="op">)</span>

<span class="co"># plot</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">df_ts</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">mu</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.75</span>, color <span class="op">=</span> <span class="st">"dodgerblue4"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Time (days)"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Adult Mortality"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Grande Comore: Hourly Death Rates for One Year"</span><span class="op">)</span></code></pre></div>
<p><img src="inhomogeneous_files/figure-html/unnamed-chunk-4-1.png" width="691.2"></p>
<p>We see that the data trends in a cyclic manner, consistent with proposed seasonality throughout the year. Mosquito mortality is highest in the early spring (days 50-150, approximately March to the end of May) and around the end of the year (days 325-365, the end of November through December).</p>
</div>
<div id="inhom_rate_fns" class="section level1">
<h1 class="hasAnchor">
<a href="#inhom_rate_fns" class="anchor"></a>Time-dependent Rate Functions</h1>
<p>We need to setup rate functions which correctly return time-dependent rates. First, we make a brief digression into the mathematical consequences and then we show how to implement them into <strong>MGDrivE2</strong></p>
<div id="math_consider" class="section level2">
<h2 class="hasAnchor">
<a href="#math_consider" class="anchor"></a>Mathematical Considerations</h2>
<p>Call <span class="math inline">\(\mu\)</span> a rate function that is time-homogeneous, meaning <span class="math inline">\(\mu(t) = \mu, t \in [0,\infty)\)</span>; for a continuous-time discrete event model, this means that the time between events is exponentially distributed. Another way of saying this is that the counting process (<span class="math inline">\(N(t)\)</span>) that counts how many times the event has “fired” (occurred) by time <span class="math inline">\(t\)</span> is a Poisson process, that is the number of events at time <span class="math inline">\(t\)</span> follows a Poisson distribution with parameter <span class="math inline">\(\mu \cdot t\)</span>. Consequently, if all events (transitions) have rates that are time-homogeneous functions then the entire model is a continuous-time Markov chain (CTMC). One reason we like CTMC models is that they incorporate stochasticity in a “mechanistic” way and have deep connections to classic ODE models, a mainstay of mathematical modelling. For a recent review of the relationship, using epidemic models as an example, see work by <a href="https://www.sciencedirect.com/science/article/pii/S2468042716300495">Linda Allen</a>.</p>
<p>Now, let the rate function depend on time, meaning <span class="math inline">\(\mu(t) \geq 0, t \in [0,\infty)\)</span>. We need to be careful now: while the rate function depends on <em>time</em>, it does not depend on <em>age</em>; that is, if the event is going to the grocery store, perhaps Alice goes to the grocery store at a different rate each day of the week, but if the rate does not depend <em>at all</em> on how long she has been waiting to go to the store (and has not yet), then we have a process that is time-dependent but not age-dependent. In other words, it is still a Markov process, but it is a time-inhomogeneous Markov process <em>even though</em> the inter-event times no longer follow an exponential distribution. In <strong>MGDrivE2</strong> we approximate an age-dependent (semi-Markov process) rate of egg/larvae/pupae development by using an Erlang distribution, which is constructed by summing exponential waiting times. If the rate parameter of the Erlang distribution varies with time, then we can simulate time-inhomogeneous semi-Markov processes.</p>
</div>
<div id="programming" class="section level2">
<h2 class="hasAnchor">
<a href="#programming" class="anchor"></a>Programming Time-Dependent Rates in MGDrivE2</h2>
<p>To make adult mortality rates time-dependent, we will need to replace the functions <code>make_male_mort_haz()</code> and <code>make_female_mort_haz()</code> with versions that return time-dependent rate functions. First, we observe the time-inhomogeneous rate function associated with female mortality (the function for male mortality is very similar):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_female_mort_haz</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trans</span>, <span class="va">u</span>, <span class="va">cube</span>, <span class="va">params</span>, <span class="va">exact</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">tol</span> <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span><span class="op">{</span>

  <span class="co"># rate constants</span>
  <span class="va">muF</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">muF</span>

  <span class="co"># which places have input arcs to this transition</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">trans</span><span class="op">$</span><span class="va">s</span>

  <span class="co"># weights of those arcs</span>
  <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">trans</span><span class="op">$</span><span class="va">s_w</span>

  <span class="co"># omega is dependent on genotype</span>
  <span class="va">f_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">u</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, split <span class="op">=</span> <span class="st">"_"</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  <span class="va">omega</span> <span class="op">&lt;-</span> <span class="va">cube</span><span class="op">$</span><span class="va">omega</span><span class="op">[</span><span class="va">f_gen</span><span class="op">]</span>

  <span class="co"># return the hazard function</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">exact</span><span class="op">)</span><span class="op">{</span>

    <span class="co"># EXACT hazards (check enabling degree: for discrete simulation only)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">trans</span>,<span class="va">M</span><span class="op">)</span><span class="op">{</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;=</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">muF</span> <span class="op">*</span> <span class="va">omega</span> <span class="op">*</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>

  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>

    <span class="co"># APPROXIMATE hazards (tolerance around zero; for continuous approximation only)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">trans</span>,<span class="va">M</span><span class="op">)</span><span class="op">{</span>
        <span class="va">haz</span> <span class="op">&lt;-</span> <span class="va">muF</span> <span class="op">*</span> <span class="va">omega</span> <span class="op">*</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">haz</span> <span class="op">&lt;</span> <span class="va">tol</span><span class="op">)</span><span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">haz</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>

  <span class="op">}</span>
  <span class="co"># end of function</span>
<span class="op">}</span></code></pre></div>
<p>The rate of the adult female mosquito mortality event firing is <span class="math inline">\(\mu_{F} \cdot \omega \cdot M[s]\)</span>, where <span class="math inline">\(M[s]\)</span> is the number of adult female tokens. We want to make it time dependent via <span class="math inline">\(\mu_{F}(t) \cdot \omega \cdot M[s]\)</span>, where <span class="math inline">\(\mu(t)\)</span> comes from our interpolating function made with <code><a href="https://rdrr.io/r/stats/stepfun.html">stepfun()</a></code>. To do so, we write a new function, <code>make_female_mort_haz_inhom()</code>. Note that we preform type checking of the object <code>muF</code> to make sure it is indeed a function, and that the returned function closure evaluates it at the input time <code>muF(t)</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_female_mort_haz_inhom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trans</span>, <span class="va">u</span>, <span class="va">cube</span>, <span class="va">params</span>,
                                       <span class="va">exact</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">tol</span> <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span><span class="op">{</span>

  <span class="co"># mortality is a time-dependent hazard</span>
  <span class="va">muF</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">muF</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">muF</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"closure"</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Inhomogeneous hazard 'make_female_mort_haz_inhom', "</span>,
         <span class="st">"'muF' in 'params' list needs to be a function"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># which places have input arcs to this transition</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">trans</span><span class="op">$</span><span class="va">s</span>

  <span class="co"># weights of those arcs</span>
  <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">trans</span><span class="op">$</span><span class="va">s_w</span>

  <span class="co"># omega is dependent on genotype</span>
  <span class="va">f_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">u</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, split <span class="op">=</span> <span class="st">"_"</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  <span class="va">omega</span> <span class="op">&lt;-</span> <span class="va">cube</span><span class="op">$</span><span class="va">omega</span><span class="op">[</span><span class="va">f_gen</span><span class="op">]</span>

  <span class="co"># return the hazard function</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">exact</span><span class="op">)</span><span class="op">{</span>

    <span class="co"># EXACT hazards (check enabling degree: for discrete simulation only)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">t</span>,<span class="va">M</span><span class="op">)</span><span class="op">{</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;=</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">muF</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">*</span> <span class="va">omega</span> <span class="op">*</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>

  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>

    <span class="co"># APPROXIMATE hazards (tolerance around zero; for continuous approximation only)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">t</span>,<span class="va">M</span><span class="op">)</span><span class="op">{</span>
        <span class="va">haz</span> <span class="op">&lt;-</span> <span class="fu">muF</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">*</span> <span class="va">omega</span> <span class="op">*</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">haz</span> <span class="op">&lt;</span> <span class="va">tol</span><span class="op">)</span><span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">haz</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>

  <span class="op">}</span>
  <span class="co"># end of function</span>
<span class="op">}</span></code></pre></div>
<p>We follow a similar procedure for the adult male mortality. The function is almost identical.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">make_male_mort_haz_inhom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">trans</span>, <span class="va">u</span>, <span class="va">cube</span>, <span class="va">params</span>,
                                     <span class="va">exact</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">tol</span> <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span><span class="op">{</span>

  <span class="co"># mortality is a time-dependent hazard</span>
  <span class="va">muM</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">muM</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/typeof.html">typeof</a></span><span class="op">(</span><span class="va">muM</span><span class="op">)</span> <span class="op">!=</span> <span class="st">"closure"</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Inhomogeneous hazard 'make_male_mort_haz_inhom', "</span>,
         <span class="st">"value 'muM' in 'params' list needs to be a function"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># which places have input arcs to this transition</span>
  <span class="va">s</span> <span class="op">&lt;-</span> <span class="va">trans</span><span class="op">$</span><span class="va">s</span>

  <span class="co"># weights of those arcs</span>
  <span class="va">w</span> <span class="op">&lt;-</span> <span class="va">trans</span><span class="op">$</span><span class="va">s_w</span>

  <span class="co"># omega is dependent on genotype</span>
  <span class="va">m_gen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html">strsplit</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">u</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, split <span class="op">=</span> <span class="st">"_"</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>
  <span class="va">omega</span> <span class="op">&lt;-</span> <span class="va">cube</span><span class="op">$</span><span class="va">omega</span><span class="op">[</span><span class="va">m_gen</span><span class="op">]</span>

  <span class="co"># return the hazard function</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">exact</span><span class="op">)</span><span class="op">{</span>

    <span class="co"># EXACT hazards (check enabling degree: for discrete simulation only)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">t</span>,<span class="va">M</span><span class="op">)</span><span class="op">{</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">w</span> <span class="op">&lt;=</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu">muM</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">*</span> <span class="va">omega</span> <span class="op">*</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>

  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>

    <span class="co"># APPROXIMATE hazards (tolerance around zero; for continuous approximation only)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span>
      <span class="kw">function</span><span class="op">(</span><span class="va">t</span>,<span class="va">M</span><span class="op">)</span><span class="op">{</span>
        <span class="va">haz</span> <span class="op">&lt;-</span> <span class="fu">muM</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">*</span> <span class="va">omega</span> <span class="op">*</span> <span class="va">M</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>
        <span class="kw">if</span><span class="op">(</span><span class="va">haz</span> <span class="op">&lt;</span> <span class="va">tol</span><span class="op">)</span><span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">haz</span><span class="op">)</span>
        <span class="op">}</span>
      <span class="op">}</span>
    <span class="op">)</span>

  <span class="op">}</span>
  <span class="co"># end of function</span>
<span class="op">}</span></code></pre></div>
<p>Now that we have time-dependent hazard functions, we also need to replace the hazard generating function, so that our time-dependent functions are used. The package provided function, <code><a href="../reference/spn_hazards.html">spn_hazards()</a></code>, generates all of our standard hazard functions. Below, we replace parts of this function for time-inhomogeneous hazards: the only differences are for transition types <code>"male_mort"</code> and <code>"female_mort"</code>, where we drop in our new functions.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">spn_hazards_lifecycle_node_inhom</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spn_P</span>, <span class="va">spn_T</span>, <span class="va">cube</span>, <span class="va">params</span>,
                                             <span class="va">log_dd</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">exact</span> <span class="op">=</span> <span class="cn">TRUE</span>,
                                             <span class="va">tol</span> <span class="op">=</span> <span class="fl">1e-12</span>, <span class="va">verbose</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">{</span>

  <span class="kw">if</span><span class="op">(</span><span class="va">tol</span> <span class="op">&gt;</span> <span class="fl">1e-6</span> <span class="op">&amp;</span> <span class="op">!</span><span class="va">exact</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="st">"warning: hazard function tolerance "</span>,<span class="va">tol</span>,<span class="st">" is large; "</span>,
            <span class="st">"consider tolerance &lt; 1e-6 for sufficient accuracy\n"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="kw">if</span><span class="op">(</span><span class="va">log_dd</span><span class="op">)</span><span class="op">{</span>
    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="st">"K"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Specified logistic (carrying capacity) density-dependent larval "</span>,
           <span class="st">"mortality, please specify parameter 'K' in params"</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="st">"gamma"</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">params</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Specified Lotka-Volterra (carrying capacity) density-dependent "</span>,
           <span class="st">"larval mortality, please specify parameter 'gamma' in params"</span><span class="op">)</span>
    <span class="op">}</span>
  <span class="op">}</span>

  <span class="co"># transitions and places</span>
  <span class="va">v</span> <span class="op">&lt;-</span> <span class="va">spn_T</span><span class="op">$</span><span class="va">v</span>
  <span class="va">u</span> <span class="op">&lt;-</span> <span class="va">spn_P</span><span class="op">$</span><span class="va">u</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span>

  <span class="co"># get male and larvae indices</span>
  <span class="va">l_ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">spn_P</span><span class="op">$</span><span class="va">ix</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">larvae</span><span class="op">)</span>
  <span class="va">m_ix</span> <span class="op">&lt;-</span> <span class="va">spn_P</span><span class="op">$</span><span class="va">ix</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">males</span>

  <span class="co"># the hazard functions</span>
  <span class="va">h</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span>object <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>,<span class="va">n</span><span class="op">)</span>, nm <span class="op">=</span> <span class="va">v</span><span class="op">)</span>


  <span class="kw">if</span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span><span class="op">{</span>
    <span class="va">pb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/txtProgressBar.html">txtProgressBar</a></span><span class="op">(</span>min <span class="op">=</span> <span class="fl">1</span>,max <span class="op">=</span> <span class="va">n</span>,style <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
    <span class="va">pp</span> <span class="op">&lt;-</span> <span class="fl">1</span>

    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">" --- generating hazard functions for SPN --- \n"</span><span class="op">)</span>
  <span class="op">}</span>

  <span class="co"># make the hazards</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span><span class="op">{</span>

    <span class="va">type</span> <span class="op">&lt;-</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">class</span>

    <span class="co"># make the correct type of hazard</span>
    <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"oviposit"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_oviposit_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                             cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                             exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"egg_adv"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_egg_adv_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                            cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                            exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"egg_mort"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_egg_mort_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                             cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                             exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"larvae_adv"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_larvae_adv_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                               cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                               exact <span class="op">=</span> <span class="va">exact</span>,tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"larvae_mort"</span><span class="op">)</span><span class="op">{</span>
      <span class="kw">if</span><span class="op">(</span><span class="va">log_dd</span><span class="op">)</span><span class="op">{</span>
        <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_larvae_mort_haz_log</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                                      l_ix <span class="op">=</span> <span class="va">l_ix</span>, node <span class="op">=</span> <span class="fl">1</span>,
                                                      cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                                      exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
      <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
        <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_larvae_mort_haz_lk</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                                     l_ix <span class="op">=</span> <span class="va">l_ix</span>, node <span class="op">=</span> <span class="fl">1</span>,
                                                     cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                                     exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
      <span class="op">}</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"pupae_adv"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_pupae_adv_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                              cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                              exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"pupae_mort"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_pupae_mort_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                               cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                               exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"pupae_2m"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_pupae_2male_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                                cube <span class="op">=</span> <span class="va">cube</span>, params <span class="op">=</span> <span class="va">params</span>,
                                                exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"pupae_2f"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_pupae_2female_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                                  m_ix <span class="op">=</span> <span class="va">m_ix</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                                  params <span class="op">=</span> <span class="va">params</span>, exact <span class="op">=</span> <span class="va">exact</span>,
                                                  tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"male_mort"</span><span class="op">)</span><span class="op">{</span>
      <span class="co"># inhomogeneous male mortality</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">make_male_mort_haz_inhom</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span> ,cube <span class="op">=</span> <span class="va">cube</span>,
                                         params <span class="op">=</span> <span class="va">params</span>, exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"female_mort"</span><span class="op">)</span><span class="op">{</span>
      <span class="co"># inhomogeneous female mortality</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">make_female_mort_haz_inhom</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                           params <span class="op">=</span> <span class="va">params</span>, exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"pupae_2unmated"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_pupae_2unmated_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                                   m_ix <span class="op">=</span> <span class="va">m_ix</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                                   params <span class="op">=</span> <span class="va">params</span>, exact <span class="op">=</span> <span class="va">exact</span>,
                                                   tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"female_unmated_mate"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE2</span><span class="fu">:::</span><span class="fu">make_unmated_2female_haz</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>,
                                                    m_ix <span class="op">=</span> <span class="va">m_ix</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                                    params <span class="op">=</span> <span class="va">params</span>, exact <span class="op">=</span> <span class="va">exact</span>,
                                                    tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"female_unmated_mort"</span><span class="op">)</span><span class="op">{</span>
      <span class="va">h</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">make_female_mort_haz_inhom</span><span class="op">(</span>trans <span class="op">=</span> <span class="va">spn_T</span><span class="op">$</span><span class="cn">T</span><span class="op">[[</span><span class="va">t</span><span class="op">]</span><span class="op">]</span>, u <span class="op">=</span> <span class="va">u</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                           params <span class="op">=</span> <span class="va">params</span>, exact <span class="op">=</span> <span class="va">exact</span>, tol <span class="op">=</span> <span class="va">tol</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"error in making hazard function for unknown class type: "</span>,<span class="va">type</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>

    <span class="kw">if</span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/utils/txtProgressBar.html">setTxtProgressBar</a></span><span class="op">(</span><span class="va">pb</span>,<span class="va">t</span><span class="op">)</span><span class="op">}</span>
  <span class="op">}</span> <span class="co"># end loop</span>

  <span class="kw">if</span><span class="op">(</span><span class="va">verbose</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/connections.html">close</a></span><span class="op">(</span><span class="va">pb</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">" --- done generating hazard functions for SPN --- \n"</span><span class="op">)</span>
  <span class="op">}</span>


  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="st">"hazards"</span><span class="op">=</span><span class="va">h</span>, <span class="st">"flag"</span><span class="op">=</span><span class="va">exact</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> <span class="co"># end function</span></code></pre></div>
</div>
</div>
<div id="make_spn" class="section level1">
<h1 class="hasAnchor">
<a href="#make_spn" class="anchor"></a>Petri Net Setup</h1>
<p>Much of the following setup is from the <a href="lifecycle-node.html">“MGDrivE2: One Node Lifecycle Dynamics”</a> vignette, with small adaptations for the time-inhomogeneous simulations.</p>
<div id="pars" class="section level2">
<h2 class="hasAnchor">
<a href="#pars" class="anchor"></a>Parameterization</h2>
<p>In a familiar procedure, we define parameters for the simulation. Note that we use the mean of the time-dependent mortality as the equilibrium value, we will use this value to run a set of time-homogeneous simulations to compare results.</p>
<p>We also set the simulation time for 1 year, as our mortality data spans a year. The data is stored daily, and we run a basic Mendelian inheritance pattern.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># number of adult female mosquitoes</span>
<span class="va">NF</span> <span class="op">&lt;-</span> <span class="fl">500</span>

<span class="co"># entomological parameters</span>
<span class="va">theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>
  qE <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">4</span>,
  nE <span class="op">=</span> <span class="fl">2</span>,
  qL <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span>,
  nL <span class="op">=</span> <span class="fl">3</span>,
  qP <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>,
  nP <span class="op">=</span> <span class="fl">2</span>,
  muE <span class="op">=</span> <span class="fl">0.05</span>,
  muL <span class="op">=</span> <span class="fl">0.15</span>,
  muP <span class="op">=</span> <span class="fl">0.05</span>,
  muF <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mu_ts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
  muM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">mu_ts</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
  beta <span class="op">=</span> <span class="fl">16</span>,
  nu <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">4</span><span class="op">/</span><span class="fl">24</span><span class="op">)</span>
<span class="op">)</span>

<span class="co"># simulation parameters</span>
<span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fl">365</span>
<span class="va">dt</span> <span class="op">&lt;-</span> <span class="fl">1</span>

<span class="co"># basic inheritance pattern</span>
<span class="va">cube</span> <span class="op">&lt;-</span> <span class="fu">MGDrivE</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MGDrivE/man/cubeMendelian.html">cubeMendelian</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="init_pn" class="section level2">
<h2 class="hasAnchor">
<a href="#init_pn" class="anchor"></a>Initialization of the Petri Net</h2>
<p>With parameters defined, we can setup the places and transition in our Petri Net. These structural components will be the same for all of the simulations, time dependent and independent.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Places and transitions for one node</span>
<span class="va">SPN_P</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spn_P_lifecycle_node.html">spn_P_lifecycle_node</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">theta</span>, cube <span class="op">=</span> <span class="va">cube</span><span class="op">)</span>
<span class="va">SPN_T</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spn_T_lifecycle_node.html">spn_T_lifecycle_node</a></span><span class="op">(</span>spn_P <span class="op">=</span> <span class="va">SPN_P</span>, params <span class="op">=</span> <span class="va">theta</span>, cube <span class="op">=</span> <span class="va">cube</span><span class="op">)</span>

<span class="co"># Stoichiometry matrix</span>
<span class="va">S</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spn_S.html">spn_S</a></span><span class="op">(</span>spn_P <span class="op">=</span> <span class="va">SPN_P</span>, spn_T <span class="op">=</span> <span class="va">SPN_T</span><span class="op">)</span></code></pre></div>
</div>
<div id="equilibria_haz" class="section level2">
<h2 class="hasAnchor">
<a href="#equilibria_haz" class="anchor"></a>Equilibrium Conditions and Hazard Functions</h2>
<p>Since equilibrium is calculated at the average adult mortality over the year, we use the parameters defined above (<code>theta</code>). However, the parameters returned by the <code><a href="../reference/equilibrium_lifeycle.html">equilibrium_lifeycle()</a></code> function, namely <code>initialCons$params$muF</code> and <code>muM</code> (adult mortality rates), need to be replaces with our time-inhomogeneous <a href="#inhom_adult_mort">step function</a>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># calculate equilibrium and setup initial conditions</span>
<span class="co">#  outputs required parameters in the named list "params"</span>
<span class="co">#  outputs intial equilibrium for adv users, "init</span>
<span class="co">#  outputs properly filled initial markings, "M0"</span>
<span class="va">initialCons</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/equilibrium_lifeycle.html">equilibrium_lifeycle</a></span><span class="op">(</span>params <span class="op">=</span> <span class="va">theta</span>, NF <span class="op">=</span> <span class="va">NF</span>, log_dd <span class="op">=</span> <span class="cn">TRUE</span>,
                                    spn_P <span class="op">=</span> <span class="va">SPN_P</span>, cube <span class="op">=</span> <span class="va">cube</span><span class="op">)</span>

<span class="co"># store homogenous params</span>
<span class="va">theta_hom</span> <span class="op">&lt;-</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">params</span>

<span class="co"># update params for inhomogeneous hazards (these are function closures)</span>
<span class="va">initialCons</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">muF</span> <span class="op">&lt;-</span> <span class="va">step_approx</span>
<span class="va">initialCons</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">muM</span> <span class="op">&lt;-</span> <span class="va">step_approx</span></code></pre></div>
<p>Now we are ready to make the vectors of hazards. We need four vectors to compare four different model formulations: time-homogeneous and inhomogeneous, for ODE and CTMC simulations.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ODE (inhomogeneous) hazards</span>
<span class="va">approx_hazards</span> <span class="op">&lt;-</span> <span class="fu">spn_hazards_lifecycle_node_inhom</span><span class="op">(</span>spn_P <span class="op">=</span> <span class="va">SPN_P</span>, spn_T <span class="op">=</span> <span class="va">SPN_T</span>,
                                                   cube <span class="op">=</span> <span class="va">cube</span>,
                                                   params <span class="op">=</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">params</span>,
                                                   exact <span class="op">=</span> <span class="cn">FALSE</span>, tol <span class="op">=</span> <span class="fl">1e-8</span>,
                                                   verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># ODE (homogeneous) hazards</span>
<span class="va">approx_hazards_hom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spn_hazards.html">spn_hazards</a></span><span class="op">(</span>spn_P <span class="op">=</span> <span class="va">SPN_P</span>, spn_T <span class="op">=</span> <span class="va">SPN_T</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                  params <span class="op">=</span> <span class="va">theta_hom</span>, type <span class="op">=</span> <span class="st">"life"</span>, log_dd <span class="op">=</span> <span class="cn">TRUE</span>,
                                  exact <span class="op">=</span> <span class="cn">FALSE</span>, tol <span class="op">=</span> <span class="fl">1e-8</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># CTMC (inhomogeneous) hazards</span>
<span class="va">exact_hazards</span> <span class="op">&lt;-</span> <span class="fu">spn_hazards_lifecycle_node_inhom</span><span class="op">(</span>spn_P <span class="op">=</span> <span class="va">SPN_P</span>, spn_T <span class="op">=</span> <span class="va">SPN_T</span>,
                                                  cube <span class="op">=</span> <span class="va">cube</span>,
                                                  params <span class="op">=</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">params</span>,
                                                  exact <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># CTMC (homogeneous) hazards</span>
<span class="va">exact_hazards_hom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spn_hazards.html">spn_hazards</a></span><span class="op">(</span>spn_P <span class="op">=</span> <span class="va">SPN_P</span>, spn_T <span class="op">=</span> <span class="va">SPN_T</span>, cube <span class="op">=</span> <span class="va">cube</span>,
                                  params <span class="op">=</span> <span class="va">theta_hom</span>, type <span class="op">=</span> <span class="st">"life"</span>, log_dd <span class="op">=</span> <span class="cn">TRUE</span>,
                                  exact <span class="op">=</span> <span class="cn">TRUE</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="sim" class="section level1">
<h1 class="hasAnchor">
<a href="#sim" class="anchor"></a>Simulation of Fully Specified SPN Model</h1>
<p>Finally, before we run simulations, we set up a release scheme to generate interesting dynamics. We will release 50 adult females and males, with homozygous recessive alleles, every week for five weeks, starting at day 25. Remember, it is important that <strong>the event names match a place name</strong> in the simulation. This format is used in <strong>MGDrivE2</strong> for consistency with solvers in <code>deSolve</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># releases</span>
<span class="va">r_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span>from <span class="op">=</span> <span class="fl">25</span>, length.out <span class="op">=</span> <span class="fl">5</span>, by <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
<span class="va">r_size</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="va">events_f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">"var"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"F_"</span>, <span class="va">cube</span><span class="op">$</span><span class="va">releaseType</span>, <span class="st">"_"</span>, <span class="va">cube</span><span class="op">$</span><span class="va">wildType</span><span class="op">)</span>,
                       <span class="st">"time"</span> <span class="op">=</span> <span class="va">r_times</span>,
                       <span class="st">"value"</span> <span class="op">=</span> <span class="va">r_size</span>,
                       <span class="st">"method"</span> <span class="op">=</span> <span class="st">"add"</span>,
                       stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">events_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="st">"var"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"M_"</span>, <span class="va">cube</span><span class="op">$</span><span class="va">releaseType</span><span class="op">)</span>,
                       <span class="st">"time"</span> <span class="op">=</span> <span class="va">r_times</span>,
                       <span class="st">"value"</span> <span class="op">=</span> <span class="va">r_size</span>,
                       <span class="st">"method"</span> <span class="op">=</span> <span class="st">"add"</span>,
                       stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">events_f</span>,<span class="va">events_m</span><span class="op">)</span></code></pre></div>
<div id="sim_ode" class="section level2">
<h2 class="hasAnchor">
<a href="#sim_ode" class="anchor"></a>Simulation: ODE Models</h2>
<p>Initially, we should numerically integrate our model, providing exact results for both time homogeneous and inhomogeneous versions. We recommend (and use!) the excellent ODE integration routines from <code>deSolve</code> to solve our deterministic models. Note that we specify the Runge-Kutta 4/5th order method (<code>method = "ode45"</code>) in the call to <code><a href="https://rdrr.io/pkg/deSolve/man/ode.html">deSolve::ode</a></code> rather than the default method (<code>method = "lsoda"</code>). This is because the default solvers behave badly with time-dependent rates. We clean up the output using functions from the <code>MGDrivE2</code> package and put it in a <code>data.frame</code> for <a href="#plots">plotting</a> below.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># ODE (inhomogeneous) simulation</span>
<span class="va">ODE_out_inhom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_trajectory_R.html">sim_trajectory_R</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">M0</span>, tmax <span class="op">=</span> <span class="va">tmax</span>, dt <span class="op">=</span> <span class="va">dt</span>,
                                  S <span class="op">=</span> <span class="va">S</span>, hazards <span class="op">=</span> <span class="va">approx_hazards</span>, sampler <span class="op">=</span> <span class="st">"ode"</span>,
                                  method <span class="op">=</span> <span class="st">"ode45"</span>, events <span class="op">=</span> <span class="va">events</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># summarize</span>
<span class="va">ODE_female_inhom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarize_females.html">summarize_females</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">ODE_out_inhom</span><span class="op">$</span><span class="va">state</span>, spn_P <span class="op">=</span> <span class="va">SPN_P</span><span class="op">)</span>
<span class="va">ODE_male_inhom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarize_males.html">summarize_males</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">ODE_out_inhom</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>

<span class="co"># combine for plotting later</span>
<span class="va">ODE_out_inhom_melt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">ODE_female_inhom</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span>,
                            <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">ODE_male_inhom</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span> <span class="op">)</span>


<span class="co"># ODE (homogeneous) simulation</span>
<span class="va">ODE_out_hom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_trajectory_R.html">sim_trajectory_R</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">M0</span>, tmax <span class="op">=</span> <span class="va">tmax</span>, dt <span class="op">=</span> <span class="va">dt</span>,
                                S <span class="op">=</span> <span class="va">S</span>, hazards <span class="op">=</span> <span class="va">approx_hazards_hom</span>, sampler <span class="op">=</span> <span class="st">"ode"</span>,
                                method <span class="op">=</span> <span class="st">"ode45"</span>, events <span class="op">=</span> <span class="va">events</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># summarize</span>
<span class="va">ODE_female_hom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarize_females.html">summarize_females</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">ODE_out_hom</span><span class="op">$</span><span class="va">state</span>, spn_P <span class="op">=</span> <span class="va">SPN_P</span><span class="op">)</span>
<span class="va">ODE_male_hom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/summarize_males.html">summarize_males</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">ODE_out_hom</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>

<span class="co"># combine for plotting later</span>
<span class="va">ODE_out_hom_melt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">ODE_female_hom</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">ODE_male_hom</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>
<span class="op">)</span>

<span class="va">ODE_out_inhom_melt</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="st">"inhomogeneous"</span>
<span class="va">ODE_out_hom_melt</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="st">"homogeneous"</span>

<span class="co"># plot everything together</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">ODE_out_inhom_melt</span>, <span class="va">ODE_out_hom_melt</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">value</span>,
                color <span class="op">=</span> <span class="va">death</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">genotype</span> <span class="op">~</span> <span class="va">sex</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"inhomogeneous"</span> <span class="op">=</span> <span class="st">"firebrick3"</span>,
                                <span class="st">"homogeneous"</span> <span class="op">=</span> <span class="st">"dodgerblue3"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># final formatting</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Constant vs Seasonally Time-Varying Mortality Rates"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="inhomogeneous_files/figure-html/unnamed-chunk-14-1.png" width="691.2"></p>
</div>
<div id="sim_ctmc" class="section level2">
<h2 class="hasAnchor">
<a href="#sim_ctmc" class="anchor"></a>Simulation: CTMC Models</h2>
<p>We run 10 realizations of the stochastic simulations, to get a better sense of the overall variability in trajectories. We can run these repetitions in two ways: using the built-in repetitions provided by <strong>MGDrivE2</strong>, or running a loop over <code><a href="../reference/sim_trajectory_R.html">sim_trajectory_R()</a></code> to generate repetitions. Both of these are valuable, but in different circumstances. The built-in repetitions provided by <strong>MGDrivE2</strong> are deliberately single-threaded (as are all analysis routines), and more efficient than running single repetitions. This is useful for parameter sweeps, where several repetitions of each parameter needs to be run. However, for very large repetitions, it is not practical to run all of the repetitions on a single-thread. In this instance, and when running many parameter combinations, it is better to setup a parallel cluster, and evaluate multiple trajectories at once. For demonstration purposes, we will setup both methods.</p>
<p>We need a few extra parameters for the stochastic realizations, namely the number of realizations and the time-step. We will run 10 repetitions, using a time step equal to one hour.</p>
<p>First we simulate the time-inhomogeneous Markov model, using the built-in repetition wrapper. Please note that this vignette does not run the following simulation code to combat excessive build times; however the code can be run locally after building the Petri net and hazards as done previously in this vignette.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># parameters for stochastic simulations</span>
<span class="va">num_rep</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">dt_stoch</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="fl">24</span>

<span class="co"># run inhomogeneous simulations</span>
<span class="va">PTS_out_inhom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_trajectory_R.html">sim_trajectory_R</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">M0</span>, tmax <span class="op">=</span> <span class="va">tmax</span>, dt <span class="op">=</span> <span class="va">dt</span>,
                                  dt_stoch <span class="op">=</span> <span class="va">dt_stoch</span>, S <span class="op">=</span> <span class="va">S</span>, num_reps <span class="op">=</span> <span class="va">num_rep</span>,
                                  hazards <span class="op">=</span> <span class="va">exact_hazards</span>, sampler <span class="op">=</span> <span class="st">"tau"</span>,
                                  events <span class="op">=</span> <span class="va">events</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

<span class="co"># summarize females/males, add sex for plotting later</span>
<span class="va">PTS_female</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="../reference/summarize_females.html">summarize_females</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">PTS_out_inhom</span><span class="op">$</span><span class="va">state</span>, spn_P <span class="op">=</span> <span class="va">SPN_P</span><span class="op">)</span>,
                    <span class="st">"sex"</span> <span class="op">=</span> <span class="st">"F"</span><span class="op">)</span>
<span class="va">PTS_male</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="../reference/summarize_males.html">summarize_males</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">PTS_out_inhom</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>, <span class="st">"sex"</span> <span class="op">=</span> <span class="st">"M"</span><span class="op">)</span>

<span class="co"># reductions for plotting</span>
<span class="va">PTS_inhom_par_unroll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">PTS_female</span>, <span class="va">PTS_male</span><span class="op">)</span>

<span class="co"># summarize_* functions return long-form data for ggplot2</span>
<span class="co">#  therefore, we take the first rep of data, the sim_time by num_genotypes</span>
<span class="co">#  Then, we reorganize the data into an array, and take the mean over every</span>
<span class="co">#  repetition</span>
<span class="va">tot_time</span> <span class="op">&lt;-</span> <span class="va">tmax</span> <span class="op">+</span> <span class="fl">1</span>
<span class="va">num_geno</span> <span class="op">&lt;-</span> <span class="va">cube</span><span class="op">$</span><span class="va">genotypesN</span>
<span class="va">PTS_inhom_par_unroll_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">PTS_female</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">tot_time</span> <span class="op">*</span> <span class="va">num_geno</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"genotype"</span>, <span class="st">"sex"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">]</span>,
        <span class="st">"Mean"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">rowMeans</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">PTS_female</span><span class="op">$</span><span class="va">value</span>,
                                              dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">tot_time</span>, <span class="va">num_geno</span>, <span class="va">num_rep</span><span class="op">)</span><span class="op">)</span>,
                                    dims <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">PTS_male</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">tot_time</span> <span class="op">*</span> <span class="va">num_geno</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"genotype"</span>, <span class="st">"sex"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">]</span>,
        <span class="st">"Mean"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html">rowMeans</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">PTS_male</span><span class="op">$</span><span class="va">value</span>,
                                              dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">tot_time</span>, <span class="va">num_geno</span>, <span class="va">num_rep</span><span class="op">)</span><span class="op">)</span>,
                                    dims <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<p>For the time-homogeneous simulation, we will demonstrate how to simulate many trajectories in parallel.</p>
<p>There are many packages available for parallel evaluation in <code>R</code>. The default package within <code>R</code> is the <code>parallel</code> package. Other useful packages include <a href="https://cran.r-project.org/package=foreach">foreach</a>, <a href="https://cran.r-project.org/package=doSNOW">doSNOW</a>, and <a href="https://cran.r-project.org/package=future">future</a>. Because <code>parallel</code> is a base package, we use it to setup a socket cluster (this cluster works on Windows and nix systems) for this example. We then use <code><a href="https://rdrr.io/r/parallel/RngStream.html">parallel::clusterSetRNGStream</a></code> to set independent, reproducible streams of random numbers for each core in the cluster.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># parameters for stochastic simulations</span>
<span class="va">num_core</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">M0</span> <span class="op">&lt;-</span> <span class="va">initialCons</span><span class="op">$</span><span class="va">M0</span>

<span class="co"># setup the cluster</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makePSOCKcluster</a></span><span class="op">(</span>names <span class="op">=</span> <span class="va">num_core</span><span class="op">)</span>

<span class="co"># set parallel seed</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/RngStream.html">clusterSetRNGStream</a></span><span class="op">(</span>cl <span class="op">=</span> <span class="va">cl</span>, iseed <span class="op">=</span> <span class="fl">18438L</span><span class="op">)</span>

<span class="co"># export required objects to each socket</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterExport</a></span><span class="op">(</span>cl<span class="op">=</span><span class="va">cl</span>, varlist<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"M0"</span>, <span class="st">"tmax"</span>, <span class="st">"dt"</span>, <span class="st">"dt_stoch"</span>, <span class="st">"S"</span>,
                                         <span class="st">"exact_hazards_hom"</span>, <span class="st">"events"</span>, <span class="st">"SPN_P"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># load MGDrivE2 on each socket</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterEvalQ</a></span><span class="op">(</span>cl<span class="op">=</span><span class="va">cl</span>, expr<span class="op">=</span><span class="op">{</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://marshalllab.github.io/MGDrivE/">MGDrivE2</a></span><span class="op">)</span><span class="op">}</span><span class="op">)</span></code></pre></div>
<p>Finally, we evaluate our function on each cluster using the load-balanced apply statement, <code><a href="https://rdrr.io/r/parallel/clusterApply.html">parallel::clusterApplyLB()</a></code>. This will run each repetition, analyze it, and store it in a list for further analysis. In this example, load-balancing is not particularly important, as these simulations are short and small, thus will have fairly consistent run times. Especially for parameter sweeps, some combinations will create significantly more complicated, and thus longer-running, dynamics, making load-balancing an important consideration.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># run homogeneous simulations</span>
<span class="va">PTS_hom_par</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/clusterApply.html">clusterApplyLB</a></span><span class="op">(</span>cl<span class="op">=</span><span class="va">cl</span>, x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">num_rep</span>, fun<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># run trajectory</span>
  <span class="va">PTS_out_hom</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim_trajectory_R.html">sim_trajectory_R</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="va">M0</span>, tmax <span class="op">=</span> <span class="va">tmax</span>, dt <span class="op">=</span> <span class="va">dt</span>,
                                  dt_stoch <span class="op">=</span> <span class="va">dt_stoch</span>, S <span class="op">=</span> <span class="va">S</span>, hazards <span class="op">=</span> <span class="va">exact_hazards_hom</span>,
                                  sampler <span class="op">=</span> <span class="st">"tau"</span>,events <span class="op">=</span> <span class="va">events</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>

  <span class="co"># summarize females/males for plotting  later</span>
  <span class="va">f_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="../reference/summarize_females.html">summarize_females</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">PTS_out_hom</span><span class="op">$</span><span class="va">state</span>, spn_P <span class="op">=</span> <span class="va">SPN_P</span><span class="op">)</span>,
                 <span class="st">"rep"</span><span class="op">=</span><span class="va">x</span>, <span class="st">"sex"</span><span class="op">=</span><span class="st">"F"</span><span class="op">)</span>
  <span class="va">m_sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="fu"><a href="../reference/summarize_males.html">summarize_males</a></span><span class="op">(</span>out <span class="op">=</span> <span class="va">PTS_out_hom</span><span class="op">$</span><span class="va">state</span><span class="op">)</span>, <span class="st">"rep"</span><span class="op">=</span><span class="va">x</span>, <span class="st">"sex"</span><span class="op">=</span><span class="st">"M"</span><span class="op">)</span>

  <span class="co"># return single dataframe</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">f_sum</span>, <span class="va">m_sum</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span>

<span class="co"># stop cluster</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="co"># summarize data</span>
<span class="co">#  the Reduce() call generates a mean of the populations</span>
<span class="va">PTS_hom_par_unroll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span><span class="op">(</span>what <span class="op">=</span> <span class="va">rbind</span>, args <span class="op">=</span> <span class="va">PTS_hom_par</span><span class="op">)</span>
<span class="va">PTS_hom_par_unroll_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">PTS_hom_par</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span> ,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"genotype"</span>, <span class="st">"sex"</span>, <span class="st">"time"</span><span class="op">)</span><span class="op">]</span>,
                                 <span class="st">"Mean"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html">Reduce</a></span><span class="op">(</span>f <span class="op">=</span> <span class="st">"+"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">PTS_hom_par</span>,
                                                                     FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span><span class="va">x</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span><span class="op">}</span><span class="op">)</span>
                                                 <span class="op">)</span><span class="op">/</span><span class="va">num_rep</span><span class="op">)</span></code></pre></div>
</div>
<div id="plots" class="section level2">
<h2 class="hasAnchor">
<a href="#plots" class="anchor"></a>Results</h2>
<p>Finally we combine the data into one plot. The ODE trajectories are plotted as dashed lines, the mean of the stochastic simulations as solid lines, and each individual stochastic trajectory is plotted as a faint curve. Lines in red are the time-inhomogeneous model runs and blue are the time-homogeneous simulations.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add mortality for plotting</span>
<span class="va">PTS_inhom_par_unroll</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="st">"inhomogeneous"</span>
<span class="va">PTS_hom_par_unroll</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="st">"homogeneous"</span>
<span class="va">ODE_out_inhom_melt</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="st">"inhomogeneous"</span>
<span class="va">ODE_out_hom_melt</span><span class="op">$</span><span class="va">death</span> <span class="op">&lt;-</span> <span class="st">"homogeneous"</span>

<span class="co"># plot everything together</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">PTS_inhom_par_unroll</span>, <span class="va">PTS_hom_par_unroll</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_path</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">value</span>, group <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">rep</span>, <span class="va">death</span><span class="op">)</span>,
                color <span class="op">=</span> <span class="va">death</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.15</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">genotype</span> <span class="op">~</span> <span class="va">sex</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"inhomogeneous"</span> <span class="op">=</span> <span class="st">"firebrick3"</span>,
                                <span class="st">"homogeneous"</span> <span class="op">=</span> <span class="st">"dodgerblue3"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># inhomogeneous mean</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">PTS_inhom_par_unroll_mean</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">Mean</span><span class="op">)</span>,
            color <span class="op">=</span> <span class="st">"firebrick4"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># homogeneous mean</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">PTS_hom_par_unroll_mean</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">Mean</span><span class="op">)</span>,
            color <span class="op">=</span> <span class="st">"dodgerblue4"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># ODE inhomogeneous</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ODE_out_inhom_melt</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>,
            linetype <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"firebrick4"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># ODE homogeneous</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">ODE_out_hom_melt</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">time</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>,
            linetype <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"dodgerblue4"</span><span class="op">)</span> <span class="op">+</span>
  <span class="co"># final formatting</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Constant vs Seasonally Time-Varying Mortality Rates"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p>There is a clear difference in population size over the course of a year. Since we used the average mortality rate to calculate the equilibrium, we see that the time-inhomogeneous simulations center around our time-homogeneous ones. Comparing the dashed-lines (ODE trajectories) to the solid-lines (SPN averages), we see that our stochastic realizations closely follow their deterministic solutions. However, the faint lines indicate significant variation is possible.</p>
<div id="ref" class="section level3">
<h3 class="hasAnchor">
<a href="#ref" class="anchor"></a>References</h3>
<ul>
<li>Anderson, David F. “A modified next reaction method for simulating chemical systems with time dependent propensities and delays.” The Journal of chemical physics 127.21 (2007): 214107.</li>
<li>Thanh, Vo Hong, and Corrado Priami. “Simulation of biochemical reactions with time-dependent rates by the rejection-based algorithm.” The Journal of chemical physics 143.5 (2015): 08B601_1.</li>
<li>Allen, Linda JS. “A primer on stochastic epidemic models: Formulation, numerical simulation, and analysis.” Infectious Disease Modelling 2.2 (2017): 128-142.</li>
</ul>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://www.slwu89.com">Sean L. Wu</a>, <a href="https://github.com/GilChrist19">Jared B. Bennett</a>, <a href="https://www.marshalllab.com">John M. Marshall</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
